#! /usr/bin/env zsh
# 
# extract a section of readme.md between firt level of title
#
#
#  - also serve as an multiline and dotall example for lookaround regex
#    "(?<=^# Tips\n)(.*?)(?=^#|\Z)"
#    "(?<=^# Tips\n)(.*?)(?=^#|\Z)"
#      |                  |     | 
#      |                  |     -> End of string (EOF when read whole file) 
#      |                  |
#      |                  ->lookahead
#      |->lookbehind
#      
#  - multiple line treat each line ^ $ as special, i.e. start and end of line
#  - mutliline-dotall makes "."  matches \n too
#
ACTION=$1
FILE="$2"
FI=${FILE%.*}

get(){
     START="$1"    
     END="$2"
     AFILE="$3"
     rg --pcre2 --multiline --multiline-dotall --no-filename --no-line-number  --no-heading \
       "(?<=$START)(.*?)(?=$END|\Z)" $AFILE
}

get_interface(){
     START='## Interface\n```c\+\+\n' 
     END='```'
     get "$START" "$END" "$1" 
}

get_implementation(){
     START='## Implementation\n```c\+\+\n' 
     END='```'
     get "$START" "$END" "$1" 
 }

get_implstub(){
     START='## ImplStub\n```c\+\+\n'
     END='```'
     get "$START" "$END" "$1" 
 }


case $ACTION in
    interface)
        get_interface $FILE
        ;;    
    impl)
        get_implementation $FILE
        ;;
    implstub)
        get_implstub $FILE
        ;;
    all)
        get_interface $FILE > $FI.h 
        #get_implstub $FILE > ${FI}Stub.cpp
        get_implementation $FILE > $FI.cpp
        ;;
    *)
        echo "$0 [interface|impl|implstub] file"
        ;;
esac
